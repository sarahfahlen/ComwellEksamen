@page "/opretelev"
@using ComwellApp.Services.Brugere
@using ComwellApp.Services.Login
@using Shared
@inject IBrugereService BrugereService
@inject ILoginService LoginService
@inject NavigationManager Navigation


<div class="opret-container">
    <button class="btn btn-primary tilbage" @onclick="Tilbage">Tilbage</button>
    
<h3 class="overskrift">Oprettelse af elev</h3>

<div class="opret-grid">
    <!-- Navn + Telefonnr -->
    <div class="form-row">
        <div class="form-floating-group halv-bredde">
            <InputText id="navn" class="form-control floating-input" @bind-Value="nyElev.Navn" placeholder=" " />
            <label for="navn">Fulde navn</label>
        </div>

        <div class="form-floating-group halv-bredde">
            <InputNumber id="telefonnr" class="form-control floating-input" @bind-Value="nyElev.BrugerTelefon" placeholder=" " />
            <label for="telefonnr">Telefon nr</label>
        </div>
    </div>

    <!-- Email -->
    <div class="form-floating-group hel-bredde">
        <InputText id="email" type="email" class="form-control floating-input" @bind-Value="nyElev.Email" placeholder=" " />
        <label for="email">E-mail</label>
    </div>

    <!-- Adgangskode -->
    <div class="form-floating-group hel-bredde">
        <InputText id="adgangskode" class="form-control floating-input" @bind-Value="nyElev.Adgangskode" placeholder=" " />
        <label for="adgangskode">Adgangskode</label>
    </div>

    <!-- Køkken + Startdato + Billede -->
    <div class="form-row">
        <div class="form-floating-group tre-delt">
            <select class="form-control" @bind="valgtKoekkenId">
                <option disabled selected value="">Vælg køkken</option>
                @foreach (var k in alleKoekkener)
                {
                    <option value="@k.LokationId">@k.LokationNavn</option>
                }
            </select>
        </div>

        <div class="form-floating-group tre-delt">
            <InputDate id="startdato" class="form-control" @bind-Value="nyElev.StartDato" />
            <label for="startdato"></label>
        </div>

        <div class="form-floating-group tre-delt">
            <label for="billede" class="input-label">Upload billede</label>
            <InputFile id="billede" class="form-control" OnChange="HandleFileSelected" />
        </div>
    </div>

    <!-- Opret-knap -->
    <div class="form-floating-group opret-knap-container">
        <button class="btn btn-primary" @onclick="HandleSubmit">Opret</button>
    </div>
</div>

<p class="note-tekst">Ved oprettelse af ny elev oprettes der automatisk en ny elevplan</p>

</div>

@code {
private int? valgtKoekkenId;
private IBrowserFile? BilledeFil;
private List<Lokation> alleKoekkener = new()
{
    new Lokation { LokationId = 1, LokationNavn = "Køkken 1" },
    new Lokation { LokationId = 2, LokationNavn = "Køkken 2" }
};

private Bruger nyElev = new()
{
    StartDato = DateOnly.FromDateTime(DateTime.Today)
};

private async Task HandleFileSelected(InputFileChangeEventArgs e)
{
    BilledeFil = e.File;
}

private void Tilbage()
{
    Navigation.NavigateTo("/dashboard");
}

private async Task HandleSubmit()
{
    Console.WriteLine("Forsøger at oprette elev...");

    if (string.IsNullOrWhiteSpace(this.nyElev.Navn) || string.IsNullOrWhiteSpace(this.nyElev.Email))
    {
        Console.WriteLine("Manglende navn eller email");
        return;
    }

    nyElev.Rolle = "Elev";
    nyElev.Koekken = alleKoekkener.FirstOrDefault(k => k.LokationId == valgtKoekkenId);


    var ansvarlig = await LoginService.GetUserLoggedIn();

    if (ansvarlig is null)
    {
        Console.WriteLine("Ingen bruger er logget ind.");
        return;
    }

    Console.WriteLine($"Ansvarlig: {ansvarlig.Navn}");

    await BrugereService.TilfoejElev(nyElev, ansvarlig);
    await LoginService.GemElevILocalStorage(nyElev);

    Console.WriteLine("Elev oprettet – redirecting...");
    Navigation.NavigateTo("/dashboard");
}
}
