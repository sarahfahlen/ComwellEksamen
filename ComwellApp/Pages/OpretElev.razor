@page "/opretelev"
@using ComwellApp.Services.Brugere
@using ComwellApp.Services.Login
@using Shared
@inject IBrugereService BrugereService
@inject ILoginService LoginService
@inject NavigationManager Navigation

<div class="opret-container">
    <button class="btn btn-primary tilbage" @onclick="Tilbage">Tilbage</button>

    <h3 class="overskrift">Oprettelse af elev</h3>

    <div class="opret-grid">
        <!-- Navn + Telefonnr -->
        <div class="form-row">
            <div class="form-floating-group halv-bredde">
                <InputText id="navn" class="form-control floating-input" @bind-Value="Navn" placeholder=" " />
                <label for="navn">Fulde navn</label>
            </div>

            <div class="form-floating-group halv-bredde">
                <InputText id="telefonnr" class="form-control floating-input" @bind-Value="Telefonnr" placeholder=" " />
                <label for="telefonnr">Telefon nr</label>
            </div>
        </div>

        <!-- Email -->
        <div class="form-floating-group hel-bredde">
            <InputText id="email" type="email" class="form-control floating-input" @bind-Value="Email" placeholder=" " />
            <label for="email">E-mail</label>
        </div>

        <!-- Adgangskode -->
        <div class="form-floating-group hel-bredde">
            <InputText id="adgangskode" class="form-control floating-input" @bind-Value="Adgangskode" placeholder=" " />
            <label for="adgangskode">Adgangskode</label>
        </div>

        <!-- Køkken + Startdato + Billede -->
        <div class="form-row">
            <div class="form-floating-group tre-delt">
                <select class="form-control" @bind="Køkken">
                    <option disabled selected value=""></option>
                    <option>Køkken 1</option>
                    <option>Køkken 2</option>
                </select>
                <label for="køkken">Køkken</label>
            </div>

            <div class="form-floating-group tre-delt">
                <InputDate id="startdato" class="form-control" @bind-Value="StartDato" />
                <label for="startdato"></label>
            </div>

            <div class="form-floating-group tre-delt">
                <InputFile OnChange="HandleFileSelected" />
                <label for="billede"></label>
            </div>
        </div>

        <!-- Opret-knap -->
        <div class="form-floating-group opret-knap-container">
            <button class="btn btn-primary" @onclick="HandleSubmit">Opret</button>
        </div>
    </div>

    <p class="note-tekst">Ved oprettelse af ny elev oprettes automatisk ny elevplan</p>
</div>

@code {
    string Navn = "";
    string Telefonnr = "";
    string Email = "";
    string Adgangskode = "";
    DateTime StartDato = DateTime.Today;
    string Køkken = "";

    private IBrowserFile? BilledeFil;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        BilledeFil = e.File;
    }

    private void Tilbage()
    {
        Navigation.NavigateTo("/dashboard");
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(Navn) || string.IsNullOrWhiteSpace(Email)) return;

        int.TryParse(Telefonnr, out int telefonInt);

        var nyElev = new Bruger
        {
            Navn = Navn,
            Email = Email,
            Adgangskode = Adgangskode,
            BrugerTelefon = telefonInt,
            Rolle = "Elev"
        };

        var ansvarlig = await LoginService.GetUserLoggedIn();

        if (ansvarlig is null)
        {
            Console.WriteLine("Ingen bruger er logget ind.");
            return;
        }
        await BrugereService.TilfoejElev(nyElev, ansvarlig);

        Navigation.NavigateTo("/dashboard");
    }
}
