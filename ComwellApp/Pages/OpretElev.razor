@page "/opretelev" 

<!-- Services vi bruger til at hente data og sende elev-info til backend -->
@using ComwellApp.Services.Brugere
@using ComwellApp.Services.Login
@using Shared
@using ComwellApp.Components
<!--Service der h√•ndterer bruger-relateret kommunikation-->
@inject IBrugereService bService 
@inject NavigationManager Navigation
@inject HttpClient http


<!-- FORMULAR: Hele visningen er en <EditForm>, som binder sig til en ny 'Bruger' (elev) -->
<EditForm Model="@nyElev" OnSubmit="HandleSubmit">
    <DataAnnotationsValidator /> <!-- S√∏rger for at validerings-attributter virker -->

    <div class="opret-container">

        <!-- Tilbage-knap -->
        <button class="tilbage-knap" @onclick="Tilbage">‚Üê Tilbage</button>

        <h3 class="overskrift">Oprettelse af elev</h3>

        <div class="opret-grid">
            <!-- Navn og telefonnummer -->
            <div class="form-row">
                <div class="form-floating-group halv-bredde">
                    <InputText id="navn" class="form-control floating-input" @bind-Value="nyElev.Navn" placeholder=" " />
                    <label for="navn">Fulde navn</label>
                    <ValidationMessage For="@(() => nyElev.Navn)" />
                </div>

                <div class="form-floating-group halv-bredde">
                    <InputText id="telefonnr" class="form-control floating-input" @bind-Value="nyElev.BrugerTelefon" placeholder=" " />
                    <label for="telefonnr">Telefon nr</label>
                    <ValidationMessage For="@(() => nyElev.BrugerTelefon)" />
                </div>
            </div>

            <!-- Email -->
            <div class="form-floating-group hel-bredde">
                <InputText id="email" type="email" class="form-control floating-input" @bind-Value="nyElev.Email" placeholder=" " />
                <label for="email">E-mail</label>
                <ValidationMessage For="@(() => nyElev.Email)" />
            </div>

            <!-- Adgangskode -->
            <div class="form-floating-group hel-bredde">
                <InputText id="adgangskode" class="form-control floating-input" @bind-Value="nyElev.Adgangskode" placeholder=" " />
                <label for="adgangskode">Adgangskode</label>
                <ValidationMessage For="@(() => nyElev.Adgangskode)" />
            </div>

            <!-- Lokation (k√∏kken), startdato og billede -->
            <div class="form-row">
                <div class="form-floating-group tre-delt">
                    <select class="form-control" @bind="KoekkenId">
                        <option disabled selected value="">V√¶lg k√∏kken</option>
                        @foreach (var k in alleKoekkener)
                        {
                            <option value="@k.LokationId">@k.LokationNavn</option>
                        }
                    </select>
                    <ValidationMessage For="@(() => valgtKoekkenId)" />
                </div>

                <div class="form-floating-group tre-delt">
                    <InputDate id="startdato" class="form-control" @bind-Value="nyElev.StartDato" />
                    <label for="startdato"></label>
                    <ValidationMessage For="@(() => nyElev.StartDato)" />
                </div>

                <div class="form-floating-group tre-delt">
                    <label for="billede" class="input-label">Upload billede</label>
                    <InputFile id="billede" class="form-control" OnChange="HandleFileSelected" />
                </div>
            </div>

            <!-- Ansvarlig k√∏kkenchef og erhverv -->
            <div class="form-row">
                <div class="form-floating-group halv-bredde">
                    <select class="form-control" @bind="nyElev.Erhverv">
                        <option disabled selected value="">V√¶lg uddannelse</option>
                        <option value="Kok">Kok</option>
                    </select>
                    <ValidationMessage For="@(() => nyElev.Erhverv)" />
                </div>
            </div>

            <!-- Gem-knap -->
            <div class="form-floating-group opret-knap-container">
                <button class="btn btn-primary" type="submit">Opret</button>
            </div>
        </div>

        <p class="note-tekst">Ved oprettelse af ny elev oprettes der automatisk en ny elevplan</p>
    </div>
</EditForm>
@if (true)
{
    <SuccessMessage Message="üî• This should show no matter what" />
}

@code {
    private int? valgtKoekkenId; // Den valgte lokation 

    private List<Bruger> koekenchefer = new(); // Alle ansvarlige k√∏kkenchefer
    private List<Lokation> alleKoekkener = new(); // Alle lokationer brugeren kan v√¶lge imellem

    private IBrowserFile? BilledeFil; // Billedet brugeren uploader
    private string successMessage; //brugt til success besked (bekr√¶ftelseskomponent
    private bool showSuccess = false;
    private bool shouldNavigate = false;
    private bool hasRedirected = false;


    // Elevens model der bindes til formularen
    private Bruger nyElev = new()
    {
        StartDato = DateOnly.FromDateTime(DateTime.Today) // S√¶t default startdato
    };

    // N√•r en lokation v√¶lges, opdaterer vi 'valgtKoekkenId' og kalder OnLokationValgt
    private int? KoekkenId
    {
        get => valgtKoekkenId;
        set
        {
            valgtKoekkenId = value;
            _ = OnLokationValgt(value); 
        }
    }

    // N√•r siden loades: hent lokationer (ikke ansvarlige endnu)
    protected override async Task OnInitializedAsync()
    {
        alleKoekkener = (await bService.HentAlleLokationer())
            .OrderBy(l => l.LokationNavn)
            .ToList();

        koekenchefer = new(); // Rydder ansvarlige indtil der v√¶lges k√∏kken
    }

    // N√•r bruger v√¶lger billede, gem det i memory
    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        BilledeFil = e.File;

        if (BilledeFil != null)
        {
            var content = new MultipartFormDataContent();
            var stream = BilledeFil.OpenReadStream(10 * 1024 * 1024);
            var fileContent = new StreamContent(stream);
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(BilledeFil.ContentType);
            content.Add(fileContent, "file", BilledeFil.Name);

            // Her skal brugerId IKKE bruges, da brugeren endnu ikke eksisterer ‚Äì du bruger en generisk endpoint
            var response = await http.PostAsync($"api/brugere/upload-profilbillede?brugerId=0", content);

            if (response.IsSuccessStatusCode)
            {
                var sti = await response.Content.ReadAsStringAsync();
                nyElev.Billede = sti;
            }
        }
    }


    // Tilbage-knappen sender brugeren til dashboard
    private void Tilbage()
    {
        Navigation.NavigateTo("/dashboard");
    }

    // N√•r brugeren trykker "Opret" gemmes eleven
    private async Task HandleSubmit()
    {
        if (valgtKoekkenId == null)
        {
            Console.WriteLine("Der er ikke valgt en lokation.");
            return;
        }

        Console.WriteLine("Fors√∏ger at oprette elev...");
        try
        {
            // Brug fallback hvis der ikke er valgt billede
            if (string.IsNullOrWhiteSpace(nyElev.Billede))
            {
                nyElev.Billede = "billeder/intetprofilbillede.jpg";
            }

            // S√¶t rolle og afdeling/lokation
            nyElev.Rolle = "Elev";
            nyElev.Afdeling = alleKoekkener.FirstOrDefault(k => k.LokationId == valgtKoekkenId);

            var ansvarlig = koekenchefer.FirstOrDefault();
            if (ansvarlig == null)
            {
                Console.WriteLine("Ingen ansvarlig k√∏kkenchef fundet.");
                return;
            }

            string skabelonNavn = nyElev.Erhverv switch
            {
                "Kok" => "KokSkabelon",
                _ => throw new Exception("Ukendt erhverv ‚Äì kan ikke v√¶lge skabelon")
            };

            await bService.TilfoejElev(nyElev, ansvarlig, skabelonNavn);

            successMessage = "Eleven blev oprettet med succes!";
            showSuccess = true;
            shouldNavigate = true;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[HandleSubmit] Der opstod en fejl: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (shouldNavigate && !hasRedirected)
        {
            hasRedirected = true;

            // Wait to let the UI render the success message before navigating
            await Task.Delay(1); // Wait for a frame to complete rendering
            StateHasChanged();   // Trigger real render

            await Task.Delay(3000); // THEN wait 3 seconds
            Navigation.NavigateTo("/dashboard");
        }
    }



    // N√•r bruger v√¶lger en lokation, henter vi ansvarlige personer (k√∏kkenchefer)
    private async Task OnLokationValgt(int? id)
    {
        if (id == null) return;

        koekenchefer = await bService.HentKoekkencheferForLokation(id.Value);

        // Ingen grund til at s√¶tte valgtKoekkenchefId l√¶ngere
        StateHasChanged();
    }
}
